name: Daily HN Digest

on:
  # ── Automatic daily run ──────────────────────────────────────────────────
  schedule:
    - cron: "0 8 * * *"   # 08:00 UTC = ~midnight Pacific / morning Europe

  # ── Manual trigger with optional overrides ───────────────────────────────
  workflow_dispatch:
    inputs:
      date:
        description: "Date to generate (YYYY-MM-DD, default: yesterday)"
        required: false
        default: ""
      ranking:
        description: "Ranking method"
        required: false
        default: "top"
        type: choice
        options: [best, top, new, ask, show]
      stories:
        description: "Number of stories (default: 20)"
        required: false
        default: "20"
      retention:
        description: "Number of days to keep in archive (default: 30)"
        required: false
        default: "30"

permissions:
  contents: write   # needed to push to gh-pages / commit generated files

jobs:
  generate:
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
      # ── 1. Checkout ──────────────────────────────────────────────────────
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          # Fetch full history so we can push to the same branch
          fetch-depth: 0

      # ── 2. Python setup ──────────────────────────────────────────────────
      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: pip

      - name: Install dependencies
        run: pip install -r requirements.txt

      # ── 3. Install Gemini CLI ───────────────────────────────────────────
      - name: Set up Node.js (for Gemini CLI)
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Gemini CLI
        run: npm install -g @google/gemini-cli

      # ── 4. Resolve inputs ────────────────────────────────────────────────
      - name: Resolve date and ranking
        id: params
        run: |
          DATE="${{ github.event.inputs.date }}"
          if [ -z "$DATE" ]; then
            DATE=$(date -u -d "yesterday" +%Y-%m-%d 2>/dev/null \
                   || date -u -v-1d +%Y-%m-%d)   # macOS fallback (runners are Linux)
          fi
          RANKING="${{ github.event.inputs.ranking }}"
          if [ -z "$RANKING" ]; then RANKING="top"; fi
          STORIES="${{ github.event.inputs.stories }}"
          if [ -z "$STORIES" ]; then STORIES="20"; fi
          RETENTION="${{ github.event.inputs.retention }}"
          if [ -z "$RETENTION" ]; then RETENTION="30"; fi
          echo "date=$DATE"     >> $GITHUB_OUTPUT
          echo "ranking=$RANKING" >> $GITHUB_OUTPUT
          echo "stories=$STORIES" >> $GITHUB_OUTPUT
          echo "retention=$RETENTION" >> $GITHUB_OUTPUT

      # ── 5. Generate digest ───────────────────────────────────────────────
      - name: Generate HN digest
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
        run: |
          python generate_daily.py \
            --date    "${{ steps.params.outputs.date }}"    \
            --ranking "${{ steps.params.outputs.ranking }}" \
            --stories "${{ steps.params.outputs.stories }}" \

      # ── 6. Commit Manifest ───────────────────────────────────────────────
      - name: Commit manifest.json
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add site/manifest.json
          if git diff --staged --quiet; then
            echo "No manifest changes."
          else
            git commit -m "chore: update manifest.json [skip ci]"
            git push
          fi

      # ── 7. Deploy to GitHub Pages ────────────────────────────────────────
      - name: Deploy
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./site
          publish_branch: gh-pages
          commit_message: "deploy: ${{ steps.params.outputs.date }} [${{ steps.params.outputs.ranking }}]"
